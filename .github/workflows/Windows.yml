name: Minecraft Google Drive Sync
on: [push]

jobs:
  sync-minecraft:
    runs-on: windows-latest

    steps:
    # 1. Setup iniziale
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Installazione rclone
    - name: Install rclone
      continue-on-error: true
      shell: powershell
      run: |
        # Download e installazione
        Invoke-WebRequest "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile rclone.zip
        Expand-Archive -Path rclone.zip -DestinationPath rclone-temp
        Copy-Item -Path "rclone-temp\rclone-*-windows-amd64\rclone.exe" -Destination "C:\Windows\System32\"
        Remove-Item -Recurse -Force rclone-temp, rclone.zip

    # 3. Configurazione Google Drive (pulita)
    - name: Configure Google Drive
      shell: powershell
      env:
        RCLONE_CLIENT_ID: ${{ secrets.RCLONE_CLIENT_ID }}
        RCLONE_CLIENT_SECRET: ${{ secrets.RCLONE_CLIENT_SECRET }}
        RCLONE_TOKEN: ${{ secrets.RCLONE_TOKEN }}
      run: |
        $configDir = "$env:APPDATA\rclone"
        New-Item -ItemType Directory -Path $configDir -Force | Out-Null

        $tokenRaw = ""
        if ($env:RCLONE_TOKEN) { $tokenRaw = $env:RCLONE_TOKEN.Trim() }

        if ([string]::IsNullOrWhiteSpace($tokenRaw)) {
          Write-Host "ERROR: RCLONE_TOKEN is empty - skipping rclone config creation"
          exit 0
        }

        try {
          $null = $tokenRaw | ConvertFrom-Json
          Write-Host "OK: Token JSON valido"
        } catch {
          Write-Host "ERROR: Token JSON non valido - skipping rclone config creation"
          exit 0
        }

        # Here-string starting at column 0 (no leading spaces)
        $configContent = @"
        [gdrive]
        type = drive
        scope = drive
        client_id = $($env:RCLONE_CLIENT_ID)
        client_secret = $($env:RCLONE_CLIENT_SECRET)
        token = $tokenRaw
        "@

        $configPath = Join-Path $configDir "rclone.conf"
        $configContent | Out-File -FilePath $configPath -Encoding utf8

        Write-Host "OK: rclone.conf creato in $configPath"
        # mostra il config senza il token per debug
        (Get-Content $configPath) -replace 'token = .*','token = ***' | ForEach-Object { $_ }

    # 4. Verifica connessione (senza dump bodies: evita leak)
    - name: Test Google Drive connection
      continue-on-error: true
      shell: powershell
      run: |
        $configPath = "$env:APPDATA\rclone\rclone.conf"
    
        if (!(Test-Path $configPath)) {
          Write-Host "WARN: Config file not found, skipping test"
          exit 0
        }
    
        rclone lsd gdrive: --config $configPath -vv 2>&1 | Tee-Object -FilePath "connection.log"
    
        if ($LASTEXITCODE -ne 0) {
          Write-Host "WARN: Connessione Google Drive fallita, continuo comunque"
          exit 0
        }
    
        Write-Host "OK: Connessione Google Drive riuscita"
        
    # 5. Preparazione cartella Minecraft
    - name: Setup Minecraft folder
      continue-on-error: true
      shell: powershell
      run: |
        $desktopPath = "C:\Users\runneradmin\Desktop\Minecraft"
        
        # Crea cartella locale
        New-Item -ItemType Directory -Path $desktopPath -Force | Out-Null
        "File generato automaticamente $(Get-Date)" | Out-File "$desktopPath\README.txt" -Encoding utf8

        Write-Host "=== Struttura cartella ==="
        Get-ChildItem -Path $desktopPath -Recurse | Format-Table FullName, Length

    # 6. Sincronizzazione iniziale
    - name: Initial sync to Google Drive
      continue-on-error: true
      shell: powershell
      run: |
        $configPath = "$env:APPDATA\rclone\rclone.conf"
        $localPath = "C:\Users\runneradmin\Desktop\Minecraft"

        if (!(Test-Path $configPath)) {
          Write-Host "WARN: rclone.conf non trovato, skip sync iniziale"
          exit 0
        }

        if (!(Test-Path $localPath)) {
          Write-Host "WARN: Cartella locale $localPath non trovata, skip sync iniziale"
          exit 0
        }

        # Crea cartella remota (non fallire se esiste)
        rclone mkdir gdrive:MinecraftBackup --config $configPath 2>$null
        if ($LASTEXITCODE -ne 0) { Write-Host "INFO: mkdir potrebbe non essere riuscito (probabilmente la cartella esiste gi√†)" }

        $maxRetries = 3
        $retryCount = 0
        $success = $false

        while ($retryCount -lt $maxRetries -and -not $success) {
          $retryCount++
          Write-Host ("Attempt {0} of {1}" -f $retryCount, $maxRetries)

          rclone sync "$localPath" gdrive:MinecraftBackup `
            --config $configPath `
            --progress `
            --create-empty-src-dirs `
            --drive-acknowledge-abuse `
            --stats 5s `
            --log-level INFO

          if ($LASTEXITCODE -eq 0) {
            $success = $true
            Write-Host "OK: Sync riuscita"
          } else {
            Write-Host ("WARN: Sync fallita (exit {0})" -f $LASTEXITCODE)
            if ($retryCount -lt $maxRetries) {
              Write-Host "Attendo 10 secondi prima del retry..."
              Start-Sleep -Seconds 10
            } else {
              Write-Host "WARN: Sincronizzazione fallita dopo $maxRetries tentativi (ma continuo perch√© continue-on-error: true)"
            }
          }
        }


    # 7. Setup Remote Desktop
    - name: Configure RDP access
      shell: powershell
      run: |
        # Abilita RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Imposta password
        $user = "runneradmin"
        $password = ConvertTo-SecureString $env:WIN_PASS -AsPlainText -Force
        Set-LocalUser -Name $user -Password $password
      env:
        WIN_PASS: ${{ secrets.WIN_PASS }}

    # 8. Configurazione ngrok
    - name: Setup ngrok tunnel
      shell: powershell
      run: |
        # Download e installazione
        Invoke-WebRequest "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        
        # Autenticazione e avvio
        .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
        Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    # 9. Mostra informazioni connessione
    - name: Show RDP connection info
      shell: powershell
      run: |
        Start-Sleep -Seconds 15  # Attendi che ngrok si avvii
        try {
            $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
            $rdpUrl = $tunnels.tunnels[0].public_url -replace "tcp://", ""
            Write-Host "=== INFORMAZIONI RDP ==="
            Write-Host "Indirizzo: $($rdpUrl.Split(':')[0])"
            Write-Host "Porta: $($rdpUrl.Split(':')[1])"
            Write-Host "Username: runneradmin"
            Write-Host "Password: ${{ secrets.WIN_PASS }}"
        } catch {
            Write-Host "‚ùå Impossibile ottenere l'URL ngrok"
            Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force
            exit 1
        }

    # 10. Attesa shutdown
    - name: Wait for shutdown signal
      shell: powershell
      run: |
        $maxDuration = 6 * 60 * 60  # 6 ore in secondi
        $interval = 30
        $elapsed = 0
        
        while ($elapsed -lt $maxDuration) {
            # Controllo file locale
            if (Test-Path "C:\Users\runneradmin\Desktop\stopVPS.inf") {
                Write-Host "üõë Trovato file di shutdown"
                break
            }
            
            # Controllo remoto (esempio con Pastebin)
            try {
                $content = (Invoke-WebRequest -Uri "https://pastebin.com/raw/qUKECE5Y" -UseBasicParsing).Content
                if ($content -match "stop") { 
                    Write-Host "üõë Ricevuto segnale di stop remoto"
                    break 
                }
            } catch { 
                Write-Host "‚ö†Ô∏è Errore controllo remoto: $_" 
            }
            
            Start-Sleep -Seconds $interval
            $elapsed += $interval
            Write-Host "‚è≥ Tempo trascorso: $elapsed/$maxDuration secondi"
        }

    # 11. Sincronizzazione finale
    - name: Final sync to Google Drive
      if: always()
      shell: powershell
      run: |
        # Interrompi ngrok
        Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force
        
        # Sincronizza cartella Minecraft
        $configPath = "$env:APPDATA\rclone\rclone.conf"
        $localPath = "C:\Users\runneradmin\Desktop\Minecraft"
        
        if (Test-Path $localPath) {
            Write-Host "üîÑ Sincronizzazione finale in corso..."
            rclone sync "$localPath" gdrive:MinecraftBackup `
                --config $configPath `
                --progress `
                --create-empty-src-dirs `
                --log-level INFO
            
            Write-Host "=== Stato finale cartella ==="
            Get-ChildItem -Path $localPath -Recurse | Format-Table FullName, Length, LastWriteTime
        } else {
            Write-Host "‚ö†Ô∏è Cartella Minecraft non trovata, skip upload save"
        }
