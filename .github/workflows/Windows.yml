name: Minecraft Google Drive Sync
on: [push]

jobs:
  sync-minecraft:
    runs-on: windows-latest

    steps:
    # 1. Setup iniziale
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Installazione rclone
    - name: Install rclone
      shell: powershell
      run: |
        # Download e installazione
        Invoke-WebRequest "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile rclone.zip
        Expand-Archive -Path rclone.zip -DestinationPath rclone-temp
        Copy-Item -Path "rclone-temp\rclone-*-windows-amd64\rclone.exe" -Destination "C:\Windows\System32\"
        Remove-Item -Recurse -Force rclone-temp, rclone.zip

    # 3. Configurazione Google Drive (pulita)
    - name: Configure Google Drive
      continue-on-error: true
      shell: powershell
      run: |
        $configDir = "$env:APPDATA\rclone"
        New-Item -ItemType Directory -Path $configDir -Force | Out-Null

        # Normalizza token (trim)
        $tokenRaw = ($env:RCLONE_TOKEN ?? "").Trim()

        # Valida JSON
        try {
          $null = $tokenRaw | ConvertFrom-Json
          Write-Host "‚úÖ Token JSON valido"
        } catch {
          Write-Host "‚ùå ERRORE: Token JSON non valido (segreto non √® JSON puro)"
          exit 1
        }

        # IMPORTANTISSIMO: here-string senza indentazione
        $configContent = @"
        [gdrive]
        type = drive
        scope = drive
        client_id = $($env:RCLONE_CLIENT_ID)
        client_secret = $($env:RCLONE_CLIENT_SECRET)
        token = $tokenRaw
        "@

        $configPath = Join-Path $configDir "rclone.conf"
        $configContent | Out-File -FilePath $configPath -Encoding utf8

        Write-Host "=== rclone.conf creato in ==="
        Write-Host $configPath

        # Mostra config "sanitizzato" (senza token)
        Write-Host "=== Verifica config (token nascosto) ==="
        (Get-Content $configPath) -replace 'token = .*', 'token = ***' | ForEach-Object { $_ }

      env:
        RCLONE_CLIENT_ID: ${{ secrets.RCLONE_CLIENT_ID }}
        RCLONE_CLIENT_SECRET: ${{ secrets.RCLONE_CLIENT_SECRET }}
        RCLONE_TOKEN: ${{ secrets.RCLONE_TOKEN }}

    # 4. Verifica connessione (senza dump bodies: evita leak)
    - name: Test Google Drive connection
      continue-on-error: true
      shell: powershell
      run: |
        $configPath = "$env:APPDATA\rclone\rclone.conf"

        # Prima: verifica che rclone legga la config
        rclone config show --config $configPath | Out-Host

        # Poi: test semplice (pi√π affidabile di "about" con scope limitati)
        rclone lsd gdrive: --config $configPath -vv 2>&1 | Tee-Object -FilePath "connection.log"

        if ($LASTEXITCODE -ne 0) {
          Write-Host "=== LOG ERRORI ==="
          Get-Content "connection.log"
          exit 1
        }

        Write-Host "‚úÖ Connessione a Google Drive riuscita"
    # 5. Preparazione cartella Minecraft
    - name: Setup Minecraft folder
      continue-on-error: true
      shell: powershell
      run: |
        $desktopPath = "C:\Users\runneradmin\Desktop\Minecraft"
        
        # Crea cartella locale
        New-Item -ItemType Directory -Path $desktopPath -Force | Out-Null
        "File generato automaticamente $(Get-Date)" | Out-File "$desktopPath\README.txt" -Encoding utf8

        Write-Host "=== Struttura cartella ==="
        Get-ChildItem -Path $desktopPath -Recurse | Format-Table FullName, Length

    # 6. Sincronizzazione iniziale
    - name: Initial sync to Google Drive
      continue-on-error: true
      shell: powershell
      run: |
        $configPath = "$env:APPDATA\rclone\rclone.conf"
        $localPath = "C:\Users\runneradmin\Desktop\Minecraft"
        
        # Crea cartella remota
        rclone mkdir gdrive:MinecraftBackup --config $configPath 2>$null || Write-Host "‚ÑπÔ∏è Cartella remota gi√† esistente"

        # Sincronizzazione con ritentativi
        $maxRetries = 3
        $retryCount = 0
        
        while ($retryCount -lt $maxRetries) {
            try {
                Write-Host "üîÑ Tentativo $($retryCount + 1) di $maxRetries"
                rclone sync "$localPath" gdrive:MinecraftBackup `
                    --config $configPath `
                    --progress `
                    --create-empty-src-dirs `
                    --drive-acknowledge-abuse `
                    --stats 5s `
                    --log-level INFO
                break
            } catch {
                $retryCount++
                if ($retryCount -eq $maxRetries) {
                    Write-Host "‚ùå Sincronizzazione fallita dopo $maxRetries tentativi"
                    exit 1
                }
                Start-Sleep -Seconds 10
            }
        }
        Write-Host "‚úÖ Sincronizzazione iniziale completata"

    # 7. Setup Remote Desktop
    - name: Configure RDP access
      shell: powershell
      run: |
        # Abilita RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Imposta password
        $user = "runneradmin"
        $password = ConvertTo-SecureString $env:WIN_PASS -AsPlainText -Force
        Set-LocalUser -Name $user -Password $password
      env:
        WIN_PASS: ${{ secrets.WIN_PASS }}

    # 8. Configurazione ngrok
    - name: Setup ngrok tunnel
      shell: powershell
      run: |
        # Download e installazione
        Invoke-WebRequest "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        
        # Autenticazione e avvio
        .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
        Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    # 9. Mostra informazioni connessione
    - name: Show RDP connection info
      shell: powershell
      run: |
        Start-Sleep -Seconds 15  # Attendi che ngrok si avvii
        try {
            $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
            $rdpUrl = $tunnels.tunnels[0].public_url -replace "tcp://", ""
            Write-Host "=== INFORMAZIONI RDP ==="
            Write-Host "Indirizzo: $($rdpUrl.Split(':')[0])"
            Write-Host "Porta: $($rdpUrl.Split(':')[1])"
            Write-Host "Username: runneradmin"
            Write-Host "Password: ${{ secrets.WIN_PASS }}"
        } catch {
            Write-Host "‚ùå Impossibile ottenere l'URL ngrok"
            Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force
            exit 1
        }

    # 10. Attesa shutdown
    - name: Wait for shutdown signal
      shell: powershell
      run: |
        $maxDuration = 6 * 60 * 60  # 6 ore in secondi
        $interval = 30
        $elapsed = 0
        
        while ($elapsed -lt $maxDuration) {
            # Controllo file locale
            if (Test-Path "C:\Users\runneradmin\Desktop\stopVPS.inf") {
                Write-Host "üõë Trovato file di shutdown"
                break
            }
            
            # Controllo remoto (esempio con Pastebin)
            try {
                $content = (Invoke-WebRequest -Uri "https://pastebin.com/raw/qUKECE5Y" -UseBasicParsing).Content
                if ($content -match "stop") { 
                    Write-Host "üõë Ricevuto segnale di stop remoto"
                    break 
                }
            } catch { 
                Write-Host "‚ö†Ô∏è Errore controllo remoto: $_" 
            }
            
            Start-Sleep -Seconds $interval
            $elapsed += $interval
            Write-Host "‚è≥ Tempo trascorso: $elapsed/$maxDuration secondi"
        }

    # 11. Sincronizzazione finale
    - name: Final sync to Google Drive
      if: always()
      shell: powershell
      run: |
        # Interrompi ngrok
        Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force
        
        # Sincronizza cartella Minecraft
        $configPath = "$env:APPDATA\rclone\rclone.conf"
        $localPath = "C:\Users\runneradmin\Desktop\Minecraft"
        
        if (Test-Path $localPath) {
            Write-Host "üîÑ Sincronizzazione finale in corso..."
            rclone sync "$localPath" gdrive:MinecraftBackup `
                --config $configPath `
                --progress `
                --create-empty-src-dirs `
                --log-level INFO
            
            Write-Host "=== Stato finale cartella ==="
            Get-ChildItem -Path $localPath -Recurse | Format-Table FullName, Length, LastWriteTime
        } else {
            Write-Host "‚ö†Ô∏è Cartella Minecraft non trovata, skip upload save"
        }
